---
layout : single
title : "[H-UP] 로그인 구현 최종 / ERD 설계"
categories: dev
tag: [flask]
sidebar:
    nav: "docs"
---

# H-UP

-  [x] ERD
-  [x] Model
-  [x] View
-  [x] Controller

html 수정한 부분도 쓰기 + 파일 구조 첨부

## Model

model 은 데이터베이스 연결부만 작성된 파일이기에 지난 포스트와 동일하다. 그러나, 타 서버에서 열었을 때에도 같은 화면이 보일 수 있도록 AWS RDS 에 배포를 진행하였기에, 관련하여 host와 user 이름만 변경해주었다.

## View

드디어 view 를 구현했다. 지난 포스팅에서 구현을 하지 못했던 이유는 blueprint에 대한 이해가 부족했기 때문이었고, 이를 구현하기 위해 이전에 대충 짚고 넘어갔던 blueprint에 대한 학습을 우선시하여 진행하였다.

### blueprint

#### app.py

```python
app.register_blueprint(user.user, url_prefix='/user')
```

#### view/user.py

```python
from flask import Flask, Blueprint, request, render_template, make_response, redirect, url_for, abort
from control.user import User
from urllib.parse import urlparse, urljoin
from flask_login import login_user, logout_user, current_user

# user blueprint 생성
user = Blueprint('user', __name__)

# next 파라미터 유효성 검사 - open redirect 취약 방지하기 위함
def is_safe_url(target):
    print('secure on')
    ref_url = urlparse(request.host_url)
    test_url = urlparse(urljoin(request.host_url, target))
    return test_url.scheme in ('http', 'https') and \
           ref_url.netloc == test_url.netloc

@user.route('/')
def user_page():
    return render_template('login.html')

@user.route('/login', methods = ['get','post'])
def login():
    id = request.form.get('id')
    pw = request.form.get('pw')

    user = User.get(id)
    next = request.args.get('next')
    print(next)
    if not is_safe_url(next):
        return abort(400)

    if not user:
        return '<script>alert("존재하지 않는 아이디입니다");history.go(-1);</script>'
    elif pw != user.pw:
        return '<script>alert("잘못된 비밀번호입니다");history.go(-1);</script>'
    else:
        login_user(user)
        return redirect(url_for('user.user_page'))

@user.route('/logout')
def logout():
    logout_user()
    return redirect(url_for('main'))
```

## Controller

```python

```