---
layout : single
title : "STAGE8. File Vulnerability (2)"
tag: [dreamhack, webhacking]
sidebar:
    nav: "docs"
---

# 드림핵 웹 ServerSide : File Vulnerability (2)

-  [x] File Download Vulnerability 실습

## File Download Vulnerability
파일 다운로드 취약점은 웹 서비스를 통해 서버의 파일 시스템에 존재하는 파일을 내려받는 과정에서 발생하는 보안 취약점이며, 이용자가 다운로드할 파일의 이름을 임의로 정할 수 있을 때 발생한다. 웹 서비스는 이용자가 파일을 다운받거나, 이미지를 불러올 때 특정 디렉토리에 있는 파일만 접근하도록 해야하는데, Path Traversal을 이용한 파일 다운로드 취약점은 파일 이름을 직접 입력받아 임의 디렉토리에 있는 파일을 다운로드 받을 수 있는 취약점을 뜻한다. <br>

|파일 다운로드 취약점이 자주 발생하는 URL 패턴|
|:------|
|https://vulnerable-web.dreamhack.io/download/?filename=notes.txt|
|https://vulnerable-web.dreamhack.io/download/?filename=../../../../../../etc/passwd|
|https://vulnerable-web.dreamhack.io/images.php?fn=6ed0dd02806fa89e233b84f4.png|


### File Download Vulnerability 실습

아래는 실습 서버 코드이다. 환경 변수로부터 가지고 오는 Secret 값을 파일 다운로드 취약점을 이용해 획득해보자

```python
# ...
Secret = os.environ("Secret")
# ...
@app.route("/download")
def download():
    filename = request.args.get("filename")
    content = open("./uploads/" + filename, "rb").read()
    return content
# ...
```

프로세스의 환경변수는 /proc/self/environ에서 확인할 수 있으며, 이용자가 프로세스 호출 전 환경변수를 bash의 명령어로 설정했다면, .bash_history에서도 이를 알 수 있다. 아래는 proc/self/environ에서 Secret 값을 읽은 사진이다

<img src = "/images/webbackground/14.png"><br>


### File Vulnerability 방지하기
업로드 취약점을 막으려면 개발자는 업로드 디렉토리를 웹 서버에서 직접 접근할 수 없도록 하거나, 업로드 디렉토리에서 CGI가 실행되지 않도록 해야하며, 업로드 된 파일 이름을 그대로 사용하지 않고 basepath와 같은 함수를 통해 파일 이름을 검증한 후 사용해야 한다. 또한, 허용할 확장자를 명시하여 그 외 확장자는 업로드될 수 없도록 해야한다.
<br><Br>
다운로드 취약점을 막으려면 요청된 파일 이름을 basepath와 같은 함수를 통해 검증하거나, 파일 이름과 1:1 맵핑되는 키를 만들어 이용자로부터 파일 이름이 아닌 키를 요청하도록 해야한다